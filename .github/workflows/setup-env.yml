name: Setup Runtime Env and Verify

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  setup-and-test:
    runs-on: ubuntu-latest
    env:
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      TELEGRAM_API_ID: ${{ secrets.TELEGRAM_API_ID }}
      TELEGRAM_API_HASH: ${{ secrets.TELEGRAM_API_HASH }}
      TWITTER_BEARER_TOKEN: ${{ secrets.TWITTER_BEARER_TOKEN }}
      YOUTUBE_API_KEY: ${{ secrets.YOUTUBE_API_KEY }}
      X_USE_SNSCRAPE: ${{ secrets.X_USE_SNSCRAPE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Write .env from GitHub Secrets (not committed)
        run: |
          cat > .env << 'EOF'
          JWT_SECRET=${JWT_SECRET}
          TELEGRAM_API_ID=${TELEGRAM_API_ID}
          TELEGRAM_API_HASH=${TELEGRAM_API_HASH}
          TWITTER_BEARER_TOKEN=${TWITTER_BEARER_TOKEN}
          YOUTUBE_API_KEY=${YOUTUBE_API_KEY}
          X_USE_SNSCRAPE=${X_USE_SNSCRAPE}
          EOF

      - name: Smoke test imports
        run: |
          python -c "import server.app; import single_pipeline.cli; print('imports_ok')"

      - name: Optional unit tests
        run: |
          pytest -q || true